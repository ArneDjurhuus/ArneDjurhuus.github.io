# SquadSpace — Coding Agent Instructions (MVP v0)

## Mission

Build **SquadSpace**: a lightweight, AI-assisted, real-time collaboration workspace for 3–15 person squads. Phase-1 delivers **Spaces**, **Realtime Notes**, **Tasks**, and a daily **AI Digest**. Optimize for **working software** over completeness.

## Success Criteria (Definition of Done)

* Dockerized stack boots with one command: `docker compose up --build`.
* Users can:

  1. Load Spaces list and detail,
  2. Create/edit a Note in real-time with multi-cursor sync,
  3. Create/update a Task,
  4. Trigger `/ai/digest` and see a summary rendered in UI.
* All endpoints have request/response validation and tests.
* Linting, type checks, and basic e2e run green in CI.

## Non-Goals (for MVP)

* Email/calendar, SSO, billing, advanced permissions, mobile apps, offline first. Defer.

## Repo/Stack (given)

* **Frontend:** Next.js 14 (TS) in `apps/web`
* **API:** NestJS + Prisma + PostgreSQL in `apps/api`
* **Realtime:** y-websocket server in `apps/yjs-server`
* **AI:** FastAPI microservice in `apps/ai`
* **DB schema:** `packages/db/prisma/schema.prisma`
* **Object storage:** S3-compatible (MinIO in dev)

## Operating Constraints

* **Security:** No secrets in code. Use `.env`. Validate inputs. Sanitize file names. CORS locked to web origin in dev.
* **Perf:** Realtime ops under 200ms round-trip locally. N+1 queries prohibited.
* **DX:** Type-safe across layers. Autogenerated clients where possible.

## Coding Standards

* **TypeScript:** strict mode, exhaustiveness checks on discriminated unions.
* **API:** DTOs with class-validator; zod on web. Return `{ ok, data | error }`.
* **UI:** Accessible components, keyboard-navigable. No blocking modals for core flows.
* **Git:** Conventional Commits (`feat:`, `fix:`, etc.). Small, atomic PRs.

## Environment Variables (dev)

* `apps/api/.env`:
  `DATABASE_URL=postgresql://squad:squad@db:5432/squadspace`
  `JWT_SECRET=devsecret`
* `apps/web/.env`:
  `NEXT_PUBLIC_API_URL=http://localhost:4000`
  `YJS_WS_URL=ws://localhost:1234`
* `apps/ai`: none required for MVP.

## High-Level Architecture

* **Web** calls **API** (HTTP/JSON).
* **Web** connects to **YJS** (WebSocket) per note `ydocId`.
* **API** owns Spaces/Tasks/Files, proxies signed S3 uploads, and logs events.
* **AI** receives `events[]` → returns digest summary; API persists digest.

## Minimal API Contracts (v0)

* `GET /health -> { ok: true }`
* `GET /spaces -> Space[]`
* `GET /spaces/:slug -> Space`
* `POST /tasks -> { title, spaceId, assigneeId?, dueAt? } -> Task`
* `PATCH /tasks/:id -> Partial<Task> -> Task`
* `POST /digests -> { spaceId } -> { id, summary }`
  *API composes `events[]` from recent changes and POSTs to `AI /digest`.*

## Data Model (MVP slice)

* `User(id, email, name?)`
* `Space(id, name, slug, plan)`
* `Membership(userId, spaceId, role)`
* `Note(id, spaceId, title, ydocId)`
* `Task(id, spaceId, title, status, assigneeId?, dueAt?)`
* `EventLog(id, spaceId, type, payload, createdAt)`

## Deliverables — Milestones & Tickets

### Milestone 1 — Foundation (Infra + DB) **(ship first)**

1. **DB bootstrap & seed**

   * Run Prisma migrate; seed demo user + space (`demo`), 1 note, 1 task.
   * Acceptance: `GET /spaces` returns `Demo Space`.
2. **API hardening**

   * Add `POST /tasks`, `PATCH /tasks/:id` with DTO validation, happy-path tests.
3. **Web Spaces list/detail**

   * `/spaces` fetch + render; `/spaces/[slug]` detail page.

### Milestone 2 — Realtime Notes

1. **Yjs Editor integration**

   * Web: Add TipTap (or ProseMirror) bound to Yjs; connect to `YJS_WS_URL` using `note.ydocId`.
   * Presence: show live cursors (initials).
   * Acceptance: Two browsers see edits instantly; refresh persists content (Yjs doc saved via provider storage or periodic API snapshot if needed later).

### Milestone 3 — Tasks UX

1. **Kanban Lite**

   * Columns: `todo | in_progress | done`.
   * Create/edit inline, drag between columns, optimistic UI.
   * Acceptance: Status updates PATCH to API; durable after reload.

### Milestone 4 — AI Digest v0

1. **Event logging + Digest**

   * API writes `EventLog` on task create/update and note title changes.
   * Endpoint `POST /digests` composes last 24h events → calls `AI /digest`.
   * Web renders returned summary on Space page.
   * Acceptance: Creating tasks changes the digest output.

## Testing & QA

* **API:** Jest unit + supertest integration for `/tasks` and `/digests`.
* **Web:** Playwright smoke: load `/`, `/spaces`, drag task, see digest text.
* **Realtime:** Manual 2-tab check; add a basic ws connectivity test.

## Runbook (dev)

* `docker compose up --build`
* Web: `http://localhost:3000`
* API: `http://localhost:4000`
* YJS: `ws://localhost:1234`
* AI:  `http://localhost:8000`

## Future Hooks (do not implement now)

* Auth (NextAuth + JWT for sockets), S3 upload flow, role-based permissions, webhooks, calendar sync.
